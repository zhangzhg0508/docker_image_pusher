name: Sync Docker Images to Aliyun ACR

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  sync:
    name: Sync Public Images to Aliyun ACR
    runs-on: ubuntu-latest
    steps:
      - name: Initial disk space check
        run: |
          echo "Initial disk space:"
          df -h /

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Login to Aliyun Container Registry
        run: |
          echo "$ALIYUN_REGISTRY_PASSWORD" | skopeo login \
            "$ALIYUN_REGISTRY" \
            --username "$ALIYUN_REGISTRY_USER" \
            --password-stdin

      - name: Sync images from images.txt
        run: |
          if [ ! -f images.txt ]; then
            echo "❌ Error: images.txt not found!" >&2
            exit 1
          fi

          while IFS= read -r line || [ -n "$line" ]; do
            # Skip empty lines and comments
            [[ -z "$line" ]] && continue
            [[ "$line" =~ ^[[:space:]]*# ]] && continue

            # Extract source image (remove platform suffix like @sha256:...)
            src_image=$(echo "$line" | awk '{print $NF}' | sed 's/@.*$//')
            echo "Processing: $src_image"

            # Parse image name and tag
            image_name_tag=$(echo "$src_image" | awk -F'/' '{print $NF}')
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
            tag=$(echo "$image_name_tag" | awk -F':' '{print ($2 == "" ? "latest" : $2)}')

            # Handle registry namespace (e.g., docker.io/library/nginx → docker.io_library_nginx)
            if [[ "$src_image" == *"/"* ]]; then
              parts=(${src_image//\// })
              if [[ ${#parts[@]} -eq 3 ]]; then
                ns_part="${parts[0]}_${parts[1]}"
              elif [[ ${#parts[@]} -eq 2 ]]; then
                ns_part="${parts[0]}"
              else
                ns_part=""
              fi
            else
              ns_part=""
            fi

            # Build destination image name
            if [[ -n "$ns_part" ]]; then
              dest_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/${ns_part}_${image_name}:$tag"
            else
              dest_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$image_name:$tag"
            fi

            echo "➡️ Copying to: $dest_image"

            # Perform direct registry-to-registry copy
            if ! skopeo copy "docker://$src_image" "docker://$dest_image"; then
              echo "❌ Failed to sync $src_image" >&2
              exit 1
            fi
          done < images.txt

      - name: Final disk space check
        run: |
          echo "Final disk space:"
          df -h /
