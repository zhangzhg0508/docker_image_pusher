name: Docker

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  build:
    name: Pull and Sync Images
    runs-on: ubuntu-latest
    steps:
      - name: Initial disk space check
        run: |
          echo "Initial disk space:"
          df -h /

      # 安全清理：只删除无用软件包，不创建大文件
      - name: Maximize build space (safe mode)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-android: 'true'
          remove-codeql: 'true'

      - name: Disk space after cleanup
        run: |
          echo "Disk space after cleanup:"
          df -h /

      - name: Cleanup residual files and deactivate LVM
        run: |
          echo "Deactivating LVM volumes..."
          sudo vgchange -an buildvg || true

          echo "Removing loop devices..."
          for dev in $(losetup -a | grep -E '(/pv\.img|/mnt/tmp-pv\.img)' | cut -d: -f1); do
            echo "Detaching $dev"
            sudo losetup -d "$dev" || true
          done

          echo "Deleting residual files..."
          sudo rm -f /pv.img /mnt/tmp-pv.img

          echo "Final disk space after cleanup:"
          df -h /

      - name: Verify no LVM artifacts remain
        run: |
          if [ -f /pv.img ]; then
            echo "ERROR: /pv.img still exists!" >&2
            ls -lh /pv.img
            exit 1
          fi
          if [ -f /mnt/tmp-pv.img ]; then
            echo "ERROR: /mnt/tmp-pv.img still exists!" >&2
            ls -lh /mnt/tmp-pv.img
            exit 1
          fi
          echo "✅ No LVM artifacts found."

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install skopeo (for direct image copy)
        run: sudo apt-get update && sudo apt-get install -y skopeo

      - name: Login to Aliyun Registry
        run: |
          echo "$ALIYUN_REGISTRY_PASSWORD" | skopeo login \
            $ALIYUN_REGISTRY \
            --username "$ALIYUN_REGISTRY_USER" \
            --password-stdin

      - name: Sync images from images.txt to Aliyun ACR
        run: |
          while IFS= read -r line || [ -n "$line" ]; do
            # Skip empty lines and comments
            [[ -z "$line" ]] && continue
            [[ "$line" =~ ^[[:space:]]*# ]] && continue

            # Extract source image (last field, remove platform if present)
            src_image=$(echo "$line" | awk '{print $NF}' | sed 's/@.*$//')
            echo "Processing: $src_image"

            # Parse image components
            image_name_tag=$(echo "$src_image" | awk -F'/' '{print $NF}')
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
            tag=$(echo "$image_name_tag" | awk -F':' '{print $2; if(NF==1) print "latest"}')

            # Handle namespace (docker.io/nginx → docker.io_nginx)
            if [[ "$src_image" == *"/"* ]]; then
              ns_part=$(echo "$src_image" | awk -F'/' '{if(NF==3) print $2; else if(NF==2) print $1}')
            else
              ns_part=""
            fi

            # Build destination image name
            if [[ -n "$ns_part" ]]; then
              dest_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/${ns_part}_${image_name}:${tag}"
            else
              dest_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$image_name:$tag"
            fi

            echo "Copying to: $dest_image"

            # Direct copy without local storage
            skopeo copy \
              "docker://$src_image" \
              "docker://$dest_image"

          done < images.txt

      - name: Final disk check
        run: |
          echo "Final disk space:"
          df -h /
